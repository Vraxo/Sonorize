@using Sonorize.Core.Models
@using Sonorize.Core.Services.Update
@using Sonorize.Core.Settings
@using Sonorize.Photino.Blazor.Shared
@using System.IO
@implements IDisposable
@inject GitHubUpdateService UpdateService
@inject SonorizeSettings AppSettings
@inject ISettingsManager<SonorizeSettings> SettingsManager

@if (_release is not null && !_isDismissed)
{
    <Modal IsVisible="true"
           Title="Update Available"
           ConfirmText="@_confirmText"
           ShowCancelButton="@(!_isDownloading)"
           OnCancel="Dismiss"
           OnConfirm="HandleConfirm">

        @if (_isDownloading)
        {
            <div class="download-state">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" style="width: @(_downloadProgress * 100)%"></div>
                </div>
                <p class="progress-text">Downloading... @(_downloadProgress.ToString("P0"))</p>
            </div>
        }
        else
        {
            <div class="update-info">
                <div class="version-badge">@_release.Version</div>
                <p class="notes">@_release.ReleaseNotes</p>
                <p class="size-info">Size: @FormatBytes(_release.SizeBytes)</p>
                <div class="warning-box">
                    <i class="fas fa-info-circle"></i>
                    <span>The app will restart automatically to apply the update.</span>
                </div>
            </div>
        }

    </Modal>
}