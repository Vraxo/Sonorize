@using System.Text.Json
@using Microsoft.JSInterop
@inject IJSRuntime JS

@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="Cancel">
        <div class="modal-container" @onclick:stopPropagation>
            <div class="modal-header">Import Theme</div>
            <div class="modal-body">
                <p style="margin-bottom:10px;">Paste the theme JSON below:</p>
                <textarea @bind="_themeJson"
                          class="form-control theme-textarea"
                          placeholder='{"accentColor": "#1DB954", "bgPrimary": "#000000", ...}'></textarea>

                @if (_hasError)
                {
                    <p class="error-text">Invalid JSON format.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn" @onclick="Cancel">Cancel</button>
                <button class="btn btn-primary" @onclick="Confirm">Import</button>
            </div>
        </div>
    </div>
}

<style>
    .theme-textarea {
        min-height: 200px;
        font-family: monospace;
        font-size: 12px;
        resize: none;
        white-space: pre;
    }

    .error-text {
        color: #ff6b6b;
        font-size: 12px;
        margin-top: 8px;
        font-weight: bold;
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<string> OnImport { get; set; }

    private string _themeJson = "";
    private bool _hasError = false;

    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            _themeJson = "";
            _hasError = false;
        }
    }

    private async Task Confirm()
    {
        if (string.IsNullOrWhiteSpace(_themeJson))
        {
            await Cancel();
            return;
        }

        try
        {
            // Basic validation that it is valid JSON
            using var doc = JsonDocument.Parse(_themeJson);
            _hasError = false;
            await OnImport.InvokeAsync(_themeJson);
        }
        catch
        {
            _hasError = true;
        }
    }

    private async Task Cancel()
    {
        await OnClose.InvokeAsync();
    }
}