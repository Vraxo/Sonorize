@using Sonorize.Core.Services
@using Sonorize.Core.Services.Audio
@using Sonorize.Core.Settings
@using Sonorize.Photino.Blazor.Shared
@using System.Globalization
@inject IPlayerService PlayerService
@inject SonorizeSettings AppSettings
@inject ISettingsManager<SonorizeSettings> SettingsManager

<Modal IsVisible="IsVisible"
       Title="Speed & Pitch"
       ConfirmText="Close"
       ShowCancelButton="@false"
       OnCancel="Close"
       OnConfirm="Close">

    @if (!PlayerService.IsFxAvailable)
    {
        <div class="error-box">
            <i class="fas fa-exclamation-triangle"></i>
            <p><strong>BASS_FX library not found.</strong><br />Speed and pitch controls are disabled.</p>
        </div>
    }
    else
    {
        <div class="sp-container">

            <!-- Tempo Control -->
            <div class="sp-card">
                <div class="sp-header">
                    <span class="sp-label"><i class="fas fa-tachometer-alt"></i> Tempo</span>
                    <button class="sp-reset-btn" @onclick="ResetTempo" disabled="@(UiTempo == 100)" title="Reset to 100%">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>

                <div class="sp-slider-row">
                    <span class="sp-minmax">0%</span>
                    <input type="range"
                           min="0" max="200" step="5"
                           value="@UiTempo"
                           @oninput="OnTempoInput"
                           class="sp-slider" />
                    <span class="sp-minmax">200%</span>
                </div>

                <div class="sp-value-row">
                    <span class="sp-value-large">@GetTempoString()</span>
                    <span class="sp-value-detail">(@((int)UiTempo)%)</span>
                </div>
            </div>

            <!-- Pitch Control -->
            <div class="sp-card">
                <div class="sp-header">
                    <span class="sp-label"><i class="fas fa-music"></i> Pitch</span>
                    <button class="sp-reset-btn" @onclick="ResetPitch" disabled="@(Math.Abs(PitchValue) < 0.1)" title="Reset to 0">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>

                <div class="sp-slider-row">
                    <span class="sp-minmax">-12</span>
                    <input type="range"
                           min="-12" max="12" step="0.5"
                           value="@PitchValue.ToString(CultureInfo.InvariantCulture)"
                           @oninput="OnPitchInput"
                           class="sp-slider" />
                    <span class="sp-minmax">+12</span>
                </div>

                <div class="sp-value-row">
                    <span class="sp-value-large">@PitchValue.ToString("0.0", CultureInfo.InvariantCulture)</span>
                    <span class="sp-value-detail">semitones</span>
                </div>
            </div>

        </div>
    }

</Modal>