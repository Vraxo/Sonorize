@inherits LayoutComponentBase
@using Sonorize.Core.Models
@using Sonorize.Core.Services
@using Sonorize.Core.Services.Audio
@using Sonorize.Core.Services.UI
@using Sonorize.Core.Services.System
@using Sonorize.Core.Services.Update
@using Sonorize.Core.Settings
@using Sonorize.Photino.Blazor.Shared.Player
@using Sonorize.Photino.Blazor.Shared.Modals
@using Microsoft.JSInterop
@implements IDisposable
@inject SonorizeSettings AppSettings
@inject ISettingsManager<SonorizeSettings> SettingsManager
@inject IPlayerService PlayerService
@inject FileImportService FileImporter
@inject IJSRuntime JS
@inject LayoutStateService LayoutState
@inject NavigationManager Nav
@inject GitHubUpdateService UpdateService

<ThemeController />
<AudioEngineStatusModal />
<UpdateAvailableModal /> <!-- NEW -->

<div class="@MainContainerClass" @ondragenter="OnDragEnter" @ondragleave="OnDragLeave">

    <div class="drag-overlay @(_isDragging ? "active" : "")">
        <div class="drag-message">
            <i class="fas fa-cloud-upload-alt"></i>
            <h2>Drop to Play</h2>
            <p>Release files to start playback</p>
        </div>
        @if (_isDragging)
        {
            <InputFile OnChange="HandleFileDrop" multiple class="drag-input" />
        }
    </div>

    <AmbientBackgroundRenderer />

    <div class="@MiddleContainerClass" style="flex: 1; display: flex; overflow: hidden; position: relative;">
        <Sidebar IsOpen="@AppSettings.Window.IsSidebarOpen" OnClose="ToggleSidebar" />

        <button class="sidebar-restore-btn @(AppSettings.Window.IsSidebarOpen ? "hidden" : "")"
                title="Open Sidebar"
                @onclick="ToggleSidebar">
            <i class="fas fa-angle-double-right"></i>
        </button>

        <main class="@MainContentClass" style="@MainContentStyle">
            <div class="main-content-padding">
                @Body
            </div>
        </main>
    </div>

    <PlayerBar />
</div>

@if (_showEq)
{
    <EqualizerModal IsVisible="true" OnClose="CloseEqualizer" />
}

@if (_showSpeedPitch)
{
    <SpeedPitchModal IsVisible="true" OnClose="CloseSpeedPitch" />
}