@using Sonorize.Core
@using Sonorize.Core.Services
@using Sonorize.Core.Services.UI
@using Sonorize.Core.Settings
@inject ThemeService ThemeService

<div class="theme-selector-row">
    <select class="form-control dropdown theme-select" value="@_selectedTheme" @onchange="OnSelectionChanged">
        <option value="" disabled selected>Select a theme...</option>
        @foreach (var themeName in _availableThemes)
        {
            <option value="@themeName">@themeName</option>
        }
    </select>

    <button class="btn btn-sm btn-danger" @onclick="DeleteSelected" disabled="@string.IsNullOrEmpty(_selectedTheme)" title="Delete Theme">
        <i class="fas fa-trash"></i>
    </button>
</div>

<style>
    .theme-selector-row {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .theme-select {
        flex-grow: 1;
        padding: 6px 10px;
        height: 32px;
    }

    .btn-danger {
        min-width: 32px;
        padding: 0 10px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

@code {
    [Parameter] public EventCallback<SonorizeTheme> OnLoadTheme { get; set; }

    private List<string> _availableThemes = new();
    private string _selectedTheme = "";

    protected override void OnInitialized()
    {
        RefreshThemes();
    }

    public void RefreshThemes()
    {
        _availableThemes = ThemeService.GetAvailableThemes();

        if (!string.IsNullOrEmpty(_selectedTheme) && !_availableThemes.Contains(_selectedTheme))
        {
            _selectedTheme = "";
        }

        StateHasChanged();
    }

    private async Task OnSelectionChanged(ChangeEventArgs e)
    {
        _selectedTheme = e.Value?.ToString() ?? "";

        if (!string.IsNullOrEmpty(_selectedTheme))
        {
            var theme = ThemeService.LoadTheme(_selectedTheme);
            if (theme != null)
            {
                await OnLoadTheme.InvokeAsync(theme);
            }
        }
    }

    private void DeleteSelected()
    {
        if (string.IsNullOrEmpty(_selectedTheme)) return;

        ThemeService.DeleteTheme(_selectedTheme);
        RefreshThemes();
    }
}