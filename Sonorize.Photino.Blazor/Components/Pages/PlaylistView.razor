@page "/playlist/{PlaylistId:guid}"
@using Sonorize.Core.Services
@using Sonorize.Core.Models
@using Sonorize.Core.Services.Audio
@using Sonorize.Core.Services.Library
@using Sonorize.Core.Settings
@using Sonorize.Core
@using Sonorize.Photino.Blazor.Shared
@using Sonorize.Photino.Blazor.Shared.Modals
@using Sonorize.Photino.Blazor.Components.Pages.Components
@inject LibraryService LibService
@inject IPlayerService PlayerService
@inject NavigationManager Nav
@inject SonorizeSettings AppSettings
@inject ISettingsManager<SonorizeSettings> SettingsManager
@implements IDisposable

<div class="header">
    <div id="header-context-controls"></div>

    <div style="display:flex; align-items:center; gap:10px; overflow:hidden;">
        @if (_isEditingName)
        {
            <input @bind="_tempName" class="header-input" style="font-size: 32px; background: #333; border: none; color: white; padding: 5px; min-width: 200px;" />
            <button class="btn-icon" @onclick="SaveName"><i class="fas fa-check"></i></button>
            <button class="btn-icon" @onclick="CancelEdit"><i class="fas fa-times"></i></button>
        }
        else
        {
            <h1 id="header-title">@(_currentPlaylist?.Name ?? "Playlist Not Found")</h1>
            @if (_currentPlaylist is not null && _currentPlaylist.Type == PlaylistType.Manual)
            {
                <button class="btn-icon" title="Rename" @onclick="StartEdit"><i class="fas fa-pencil-alt"></i></button>
            }
            @if (_currentPlaylist?.Type == PlaylistType.File)
            {
                <span title="Synced from file" style="font-size: 12px; background: #333; padding: 4px 8px; border-radius: 4px; margin-left: 10px; color: #aaa;">
                    <i class="fas fa-file-code"></i> FILE
                </span>
            }
        }
    </div>

    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="search-input" placeholder="Search playlist..."
               @bind="_searchQuery"
               @bind:event="oninput"
               @onkeyup="FilterPlaylist" />
    </div>

    <div class="header-controls header-right">
        <button class="header-action-btn"
                title="@(_viewMode == LibraryViewMode.List ? "Switch to Grid" : "Switch to List")"
                @onclick="ToggleViewMode">
            <i class="fas @(_viewMode == LibraryViewMode.List ? "fa-th-large" : "fa-list")"></i>
        </button>

        <button class="header-action-btn" @onclick="GoToSettings">
            <i class="fas fa-cog"></i>
        </button>
    </div>
</div>



@if (_currentPlaylist is not null)
{
    @if (_viewMode == LibraryViewMode.List)
    {
        <TrackTable Songs="_filteredSongs"
                    EmptyMessage="@(string.IsNullOrWhiteSpace(_searchQuery) ? "This playlist is empty." : "No songs found.")"
                    AllowReorder="@IsReorderAllowed"
                    CurrentSortColumn="@_sortColumn"
                    IsAscending="@_isAscending"
                    OnSort="Sort"
                    OnPlay="PlayPlaylist"
                    OnReorder="HandleReorder"
                    OnOptionsClick="OpenOptions" />
    }
    else
    {
        <div class="library-grid-container" style="padding-top:0;">
            <LibraryGrid Songs="_filteredSongs"
                         OnSongClick="HandleGridClick" />
        </div>
    }
}

<TrackActionsModal IsVisible="_showActionsModal"
                   Song="_selectedSongForModal"
                   OnClose="CloseOptions"
                   OnEditMetadata="OpenMetadataEditor" />

<MetadataEditorModal IsVisible="_showMetadataEditor"
                     Song="_selectedSongForModal"
                     OnClose="CloseMetadataEditor" />